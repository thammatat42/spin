<html>
    <head>
        <title>Spinning Wheel</title>
        <link rel="stylesheet" href="main.css" type="text/css" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
        <script type="text/javascript" src="../Winwheel.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    </head>
    <body>
        <div class="row">
            <div class="col-md-8" align="center">
                <h1>Win prizes by spinning the wheel</h1>
                <table cellpadding="0" cellspacing="0" border="0">
                    <tr>
                        <td>
                            <div class="power_controls">
                                <table class="power" cellpadding="10" cellspacing="0">
                                    <tr>
                                        <th align="center">Power</th>
                                    </tr>
                                    <tr>
                                        <td width="78" align="center" id="pw3" onClick="powerSelected(3);">High</td>
                                    </tr>
                                    <tr>
                                        <td align="center" id="pw2" onClick="powerSelected(2);">Med</td>
                                    </tr>
                                    <tr>
                                        <td align="center" id="pw1" onClick="powerSelected(1);">Low</td>
                                    </tr>
                                </table>
                                <br />
                                <img id="spin_button" src="spin_on.png" alt="Spin" onClick="startSpin();" />
                                <br /><br />
                                &nbsp;&nbsp;<a href="#" onClick="resetWheel(); return false;">Play Again</a><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(reset)
                            </div>
                        </td>
                        <td width="438" height="582" class="the_wheel wheel-container" align="center" valign="center">
                            <canvas id="canvas" width="434" height="434">
                                <p style="color: white" align="center">Sorry, your browser doesn't support canvas. Please try another.</p>
                            </canvas>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="col-md-4">
                <h1>Winners of the prize</h1>
                <div class="table-responsive">
                    <table id="winnersTable" class="table table-bordered">
                        <tbody id="winnersTableBody">
                            <!-- Winners will be displayed here -->
                        </tbody>
                    </table>
                </div>

            </div>
            
        </div>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <script>
            // Vars used by the code in this page to do power controls.
            let wheelPower    = 0;
            let wheelSpinning = false;
            let theWheel;
            let employees = [];
            let availablePrizes = []; // Store available prizes
            let winners = []; // Store winners
            let total = 0;

            loadPrizes();
            loadEmployees();

            async function loadPrizes() {
                try {
                    const response = await axios.get('http://localhost:3000/spin/prize/list?page=1&size=100');
                    const prizes = response.data.data; // Assuming response.data is an array of prize objects

                    if (prizes.length == 0) {
                        document.getElementById('spin_button').src       = "spin_off.png";
                        document.getElementById('spin_button').className = "";
                    }

                    // Initialize availablePrizes array
                    initAvailablePrizes(prizes);

                    // Map the fetched prizes to the format expected by Winwheel.js
                    const wheelSegments = prizes.map((prize, index) => {

                        return {
                            'fillStyle': getRandomColor(), // Assuming you have a function to generate random colors
                            'text': prize.id.toString() // Assuming the prize object has a 'name' property
                        };
                    });
                    
                    // Create the Winwheel object with the dynamically fetched segments
                    theWheel = new Winwheel({
                        'numSegments': wheelSegments.length,
                        'outerRadius': 212,
                        'innerRadius': 120,
                        'textFontSize': 16,
                        'textMargin': 0,
                        'segments': wheelSegments,
                        'animation': {
                            'type': 'spinToStop',
                            'duration': 5,
                            'spins': 5,
                            'callbackFinished': alertPrize
                        }
                    });
                } catch (error) {
                    console.error('Error fetching prizes:', error);
                }
            }

            async function loadEmployees() {
                try {
                    const response = await axios.get('http://localhost:3000/spin/name/all?page=1&size=2000');
                    employees = response.data.data; // Assuming response.data is an array of employee objects

                } catch (error) {
                    console.error('Error fetching employees:', error);
                }
            }
            
            // -------------------------------------------------------
            // Function to auto generate color.
            // -------------------------------------------------------

            function getRandomColor() {
                let letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }

            // -------------------------------------------------------
            // Function to handle the onClick on the power buttons.
            // -------------------------------------------------------

            function powerSelected(powerLevel)
            {
                // Ensure that power can't be changed while wheel is spinning.
                if (wheelSpinning == false) {
                    // Reset all to grey incase this is not the first time the user has selected the power.
                    document.getElementById('pw1').className = "";
                    document.getElementById('pw2').className = "";
                    document.getElementById('pw3').className = "";

                    // Now light up all cells below-and-including the one selected by changing the class.
                    if (powerLevel >= 1) {
                        document.getElementById('pw1').className = "pw1";
                    }

                    if (powerLevel >= 2) {
                        document.getElementById('pw2').className = "pw2";
                    }

                    if (powerLevel >= 3) {
                        document.getElementById('pw3').className = "pw3";
                    }

                    // Set wheelPower var used when spin button is clicked.
                    wheelPower = powerLevel;

                    // Light up the spin button by changing it's source image and adding a clickable class to it.
                    document.getElementById('spin_button').src = "spin_on.png";
                    document.getElementById('spin_button').className = "clickable";
                }
            }

            // -------------------------------------------------------
            // Click handler for spin button.
            // -------------------------------------------------------

            function startSpin()
            {
                // Ensure that spinning can't be clicked again while already running.
                if (wheelSpinning == false) {
                    // Based on the power level selected adjust the number of spins for the wheel, the more times is has
                    // to rotate with the duration of the animation the quicker the wheel spins.
                    if (wheelPower == 1) {
                        theWheel.animation.spins = 3;
                    } else if (wheelPower == 2) {
                        theWheel.animation.spins = 8;
                    } else if (wheelPower == 3) {
                        theWheel.animation.spins = 15;
                    }

                    // Disable the spin button so can't click again while wheel is spinning.
                    document.getElementById('spin_button').src       = "spin_off.png";
                    document.getElementById('spin_button').className = "";

                    // Begin the spin animation by calling startAnimation on the wheel object.
                    theWheel.startAnimation();

                    // Set to true so that power can't be changed and spin button re-enabled during
                    // the current animation. The user will have to reset before spinning again.
                    wheelSpinning = true;
                }
            }

            // -------------------------------------------------------
            // Function for reset button.
            // -------------------------------------------------------

            function resetWheel()
            {
                theWheel.stopAnimation(false);  // Stop the animation, false as param so does not call callback function.
                theWheel.rotationAngle = 0;     // Re-set the wheel angle to 0 degrees.
                theWheel.draw();                // Call draw to render changes to the wheel.

                document.getElementById('pw1').className = "";  // Remove all colours from the power level indicators.
                document.getElementById('pw2').className = "";
                document.getElementById('pw3').className = "";

                document.getElementById('spin_button').src = "spin_on.png";
                document.getElementById('spin_button').className = "clickable";

                wheelSpinning = false;          // Reset to false to power buttons and spin can be clicked again.

                loadPrizes();
                loadEmployees();
            }

            // -------------------------------------------------------

            // Function to initialize availablePrizes array
            function initAvailablePrizes(prizes) {
                availablePrizes = prizes.map(prize => prize.prizes);
            }

            async function alertPrize(indicatedSegment) {
                const selectedPrize = indicatedSegment.text;

                // Remove selected prize from available prizes
                const prizeIndex = availablePrizes.indexOf(selectedPrize);
                if (prizeIndex > -1) {
                    availablePrizes.splice(prizeIndex, 1);
                }

                const response = await axios.get('http://localhost:3000/spin/prize/' + selectedPrize);
                const prizes = response.data.data.prizes;
                
                Swal.fire({
                    title: "<strong>Ready to Random Name!</strong>",
                    icon: "success",
                    html: `
                        Next to random name for <b>${prizes}</b>
                    `,
                    showCloseButton: true,
                    showCancelButton: true,
                    focusConfirm: false,
                    confirmButtonText: `
                        <i class="fa-solid fa-gift"></i> Go!
                    `,
                    confirmButtonAriaLabel: "Great!",
                    cancelButtonText: `
                        <i class="fa-solid fa-xmark"></i> Cancel!
                    `,
                    cancelButtonAriaLabel: "Thumbs down",
                    allowOutsideClick: false,
                    allowEscapeKey: false
                }).then(async (result) => {

                    if (result.isConfirmed) {
                        const prizeWinners = await selectWinners(selectedPrize);
                        winners.push(prizeWinners);

                        //Remove prize with api
                        const response = await axios.put('http://localhost:3000/spin/prize/remove/' + selectedPrize);

                        console.log(response);

                        // Update UI or perform actions with winners data
                        displayWinners();
                        resetWheel();
                    } else {
                        // Reset wheel
                        resetWheel();
                    }
                })
            }


             // Function to randomly select 5 winners for a prize
             async function selectWinners(prizeName) {
                try {
                    const response = await axios.get('http://localhost:3000/spin/prize/' + prizeName);
                    const total_prize = response.data.data.total;
                    const prizes = response.data.data.prizes;
                    const prizeId = prizeName;

                    const data = await RandomName(prizeId, prizes, total_prize);
                    console.log("data: ", data);

                    return { 
                        prize: prizes, 
                        winners: data.winners, 
                        total: total_prize 
                    };
                } catch (error) {
                    console.error('Error fetching prizes:', error);
                    return null;
                }
            }
            
            async function RandomName(prizeId, prizeName, total_prize) {

                //Random name follow total prize
                const availableWinners = employees.map(employee  => employee.emp_name);
                const selectedWinners = [];

                for (let i = 0; i < parseInt(total_prize); i++) {
                    const randomIndex = Math.floor(Math.random() * availableWinners.length);
                    const winner = availableWinners[randomIndex];

                    const emp_id = winner.split(' ')[0].slice(1, -1);

                    await updateFlag(emp_id, prizeId);

                    console.log('Selected winner:', winner, emp_id);
                    selectedWinners.push(winner);
                    availableWinners.splice(randomIndex, 1);
                }

                return { prize: prizeName, winners: selectedWinners, total: total_prize };
            }

            async function updateFlag(empId, prizeId) {
                try {

                    const data = {
                        emp_id: empId,
                        prize_id: prizeId
                    }
                
                    const response = await axios.post('http://localhost:3000/spin/name/remove', data);

                    console.log(`Flag updated for emp_id ${empId}`);
                } catch (error) {
                    console.error(`Error updating flag for emp_id ${empId}:`, error);
                }
            }

            // Function to display winners in the table
            function displayWinners() {
                const winnersTableBody = document.getElementById('winnersTableBody');
                winnersTableBody.innerHTML = '';
                console.log('Displaying winners:', winners);

                winners.slice(-total).forEach(prize => {
                    console.log('Displaying winners for prize:', prize);
                    const row = document.createElement('tr');
                    const prizeCell = document.createElement('td');
                    const winnersCell = document.createElement('td');

                    prizeCell.textContent = prize.prize;
                    winnersCell.textContent = prize.winners.join(', ');

                    row.appendChild(prizeCell);
                    row.appendChild(winnersCell);
                    winnersTableBody.appendChild(row);
                });
            }

        </script>
    </body>
</html>
